{% extends 'base.html.twig' %}

{% block title %}Dashboard Valorisateur | WasteWise TN{% endblock %}

{% block body %}
<div class="ww-app">

  {# ===== SIDEBAR ===== #}
  <aside class="ww-side">
    <div class="ww-side-head">
      <div class="ww-side-logo">WW</div>
      <div>
        <div class="ww-side-brand">WasteWise <span>TN</span></div>
        <div class="ww-side-tag">Espace Valorisateur</div>
      </div>
    </div>

    {% set userLabel = app.user ? app.user.userIdentifier : 'Invit√©' %}
    {% set firstChar = userLabel|first|upper %}

    <div class="ww-side-user">
      <div class="ww-avatar">{{ firstChar }}</div>
      <div>
        <div class="ww-user-email">{{ userLabel }}</div>
        <div class="ww-user-meta">
          <span class="ww-pill ww-info">VALORIZER</span>

          {% if attribute(app.user, 'isVerified') is defined and app.user.isVerified %}
            <span class="ww-pill ww-ok">‚úî V√©rifi√©</span>
          {% else %}
            <span class="ww-pill ww-warn">‚ö† Non v√©rifi√©</span>
          {% endif %}
        </div>
      </div>
    </div>

    <nav class="ww-side-nav">
      <a class="ww-nav-item active" href="{{ path('app_dashboard_valorizateur') }}">
        <span class="ww-nav-ic">üè≠</span> Dashboard
      </a>

      <a class="ww-nav-item" href="#liste">
        <span class="ww-nav-ic">‚è≥</span> D√©chets en attente
      </a>

     <a class="ww-nav-item" href="{{ path('app_valorizateur_historique') }}">
  <span class="ww-nav-ic">üìÅ</span> Historique
</a>


      <div class="ww-nav-sep"></div>

      <a class="ww-nav-item danger" href="{{ path('app_logout') }}">
        <span class="ww-nav-ic">üö™</span> D√©connexion
      </a>
    </nav>

    <div class="ww-side-foot">¬© {{ "now"|date("Y") }} WasteWise TN</div>
  </aside>

  {# ===== MAIN ===== #}
  <main class="ww-main">

    {# ‚úÖ FLASH MESSAGES (plus complet) #}
    {% for msg in app.flashes('success') %}
      <div class="ww-alert" style="margin-bottom:16px;border-color:#bbf7d0;background:#ecfdf3;color:#166534;">
        {{ msg }}
      </div>
    {% endfor %}
    {% for msg in app.flashes('error') %}
      <div class="ww-alert" style="margin-bottom:16px;border-color:#fecaca;background:#fff1f2;color:#991b1b;">
        {{ msg }}
      </div>
    {% endfor %}
    {% for msg in app.flashes('warning') %}
      <div class="ww-alert" style="margin-bottom:16px;border-color:#fde68a;background:#fffbeb;color:#92400e;">
        {{ msg }}
      </div>
    {% endfor %}
    {% for msg in app.flashes('info') %}
      <div class="ww-alert" style="margin-bottom:16px;border-color:#bfdbfe;background:#eff6ff;color:#1d4ed8;">
        {{ msg }}
      </div>
    {% endfor %}

    <div class="ww-topbar">
      <div>
        <div class="ww-h1">üè≠ Dashboard Valorisateur</div>
        <div class="ww-sub">Valider / refuser les d√©clarations</div>
      </div>

      <div class="ww-top-actions">
        {% if countEnAttente|default(0) > 0 %}
          <a class="ww-top-btn primary" href="#liste">Voir les demandes</a>
        {% else %}
          <a class="ww-top-btn" href="#liste" style="opacity:.6; pointer-events:none;">Aucune demande</a>
        {% endif %}
      </div>
    </div>

    {# ‚úÖ KPI #}
    <div class="ww-grid-3">
      <div class="ww-stat">
        <div class="ww-stat-label">En attente</div>
        <div class="ww-stat-value">{{ countEnAttente|default(0) }}</div>
        <div class="ww-stat-hint">√† traiter</div>
      </div>

      <div class="ww-stat">
        <div class="ww-stat-label">Valid√©es</div>
        <div class="ww-stat-value">{{ countValide|default(0) }}</div>
        <div class="ww-stat-hint">global</div>
      </div>

      <div class="ww-stat">
        <div class="ww-stat-label">Refus√©es</div>
        <div class="ww-stat-value">{{ countRefuse|default(0) }}</div>
        <div class="ww-stat-hint">global</div>
      </div>
    </div>

    {# ‚úÖ LISTE EN_ATTENTE #}
    <section id="liste" class="ww-card2">
      <div class="ww-card2-title">D√©clarations en attente</div>

      {% if enAttente|default([]) is empty %}
        <div class="ww-note">Aucune d√©claration en attente ‚úÖ</div>
      {% else %}
        <div style="overflow:auto;">
          <table class="ww-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Quantit√© (kg)</th>
                <th>Localisation</th>
                <th>Citoyen</th>
                <th>Date</th>
                <th style="text-align:right;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for d in enAttente %}
                {# Badge de statut (au cas o√π) #}
                {% set tagClass = d.statut == 'VALIDE' ? 'ww-tag-ok' : (d.statut == 'REFUSE' ? 'ww-tag-bad' : 'ww-tag-warn') %}

                <tr>
                  <td>#{{ d.id }}</td>
                  <td>
                    <b>{{ d.type|e }}</b>
                    <div style="margin-top:6px;">
                      <span class="ww-tag {{ tagClass }}">{{ d.statut|replace({'_':' '}) }}</span>
                    </div>
                  </td>
                  <td>{{ d.quantiteKg }} kg</td>

                  <td>
                    {% if d.adresse %}
                      {{ d.adresse|e }}
                    {% elseif d.latitude and d.longitude %}
                      {{ d.latitude }}, {{ d.longitude }}
                    {% else %}
                      ‚Äî
                    {% endif %}
                  </td>

                  <td>{{ d.user ? d.user.email : '‚Äî' }}</td>
                  <td>{{ d.createdAt ? d.createdAt|date('d/m/Y H:i') : '‚Äî' }}</td>

                  <td style="text-align:right; white-space:nowrap;">
                    {# ‚úÖ CSRF + confirmation #}
                    <form method="post"
                          action="{{ path('val_dechet_valider', {id: d.id}) }}"
                          style="display:inline;"
                          onsubmit="return confirm('Valider cette d√©claration (#{{ d.id }}) ?');">
                      <input type="hidden" name="_token" value="{{ csrf_token('dechet_validate_' ~ d.id) }}">
                      <button class="ww-btn ww-btn-mini" type="submit">Valider</button>
                    </form>

                    <form method="post"
                          action="{{ path('val_dechet_refuser', {id: d.id}) }}"
                          style="display:inline; margin-left:6px;"
                          onsubmit="return confirm('Refuser cette d√©claration (#{{ d.id }}) ?');">
                      <input type="hidden" name="_token" value="{{ csrf_token('dechet_refuse_' ~ d.id) }}">
                      <button class="ww-btn ww-btn-mini ww-btn-danger" type="submit">Refuser</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="ww-note" style="margin-top:12px;">
          Astuce : les actions sont s√©curis√©es (CSRF) et demandent confirmation.
        </div>
      {% endif %}
    </section>

  </main>
</div>
{% endblock %}
