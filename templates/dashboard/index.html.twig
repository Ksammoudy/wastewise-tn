{% extends 'base.html.twig' %}

{% block title %}Dashboard | WasteWise TN{% endblock %}

{% block body %}
<div class="ww-app">

  {# ===== SIDEBAR ===== #}
  <aside class="ww-side">
    <div class="ww-side-head">
      <div class="ww-side-logo">WW</div>
      <div>
        <div class="ww-side-brand">WasteWise <span>TN</span></div>
        <div class="ww-side-tag">Plateforme citoyenne</div>
      </div>
    </div>

    {% set userLabel = app.user ? app.user.userIdentifier : 'InvitÃ©' %}
    {% set firstChar = userLabel|first|upper %}

    <div class="ww-side-user">
      <div class="ww-avatar">{{ firstChar }}</div>
      <div>
        <div class="ww-user-email">{{ userLabel }}</div>

        <div class="ww-user-meta">
          <span class="ww-pill ww-info">
            {{ attribute(app.user, 'type') is defined ? app.user.type : 'USER' }}
          </span>

          {% if attribute(app.user, 'isVerified') is defined and app.user.isVerified %}
            <span class="ww-pill ww-ok">âœ” VÃ©rifiÃ©</span>
          {% else %}
            <span class="ww-pill ww-warn">âš  Non vÃ©rifiÃ©</span>
          {% endif %}
        </div>
      </div>
    </div>

    <nav class="ww-side-nav">
      <a class="ww-nav-item active" href="{{ path('app_dashboard') }}">
        <span class="ww-nav-ic">ğŸ </span> Dashboard
      </a>

      <a class="ww-nav-item" href="{{ path('dechet_nouveau') }}">
        <span class="ww-nav-ic">ğŸ—‘ï¸</span> DÃ©clarer un dÃ©chet
      </a>

      <a class="ww-nav-item" href="#" onclick="alert('BientÃ´t disponible'); return false;">
        <span class="ww-nav-ic">ğŸ“„</span> Mes dÃ©clarations
      </a>

      <a class="ww-nav-item" href="#" onclick="alert('BientÃ´t disponible'); return false;">
        <span class="ww-nav-ic">ğŸ</span> RÃ©compenses
      </a>

      <div class="ww-nav-sep"></div>

      <a class="ww-nav-item danger" href="{{ path('app_logout') }}">
        <span class="ww-nav-ic">ğŸšª</span> DÃ©connexion
      </a>
    </nav>

    <div class="ww-side-foot">Â© {{ "now"|date("Y") }} WasteWise TN</div>
  </aside>

  {# ===== MAIN ===== #}
  <main class="ww-main">

    {# âœ… FLASH MESSAGES #}
    {% for msg in app.flashes('success') %}
      <div class="ww-alert" style="margin-bottom:16px;border-color:#bbf7d0;background:#ecfdf3;color:#166534;">
        {{ msg }}
      </div>
    {% endfor %}
    {% for msg in app.flashes('error') %}
      <div class="ww-alert" style="margin-bottom:16px;border-color:#fecaca;background:#fff1f2;color:#991b1b;">
        {{ msg }}
      </div>
    {% endfor %}
    {% for msg in app.flashes('info') %}
      <div class="ww-alert" style="margin-bottom:16px;border-color:#bfdbfe;background:#eff6ff;color:#1d4ed8;">
        {{ msg }}
      </div>
    {% endfor %}

    <div class="ww-topbar">
      <div>
        <div class="ww-h1">ğŸ  Dashboard</div>
        <div class="ww-sub">
          Bienvenue <b>{{ userLabel }}</b>
        </div>
      </div>

      <div class="ww-top-actions">
        <a class="ww-top-btn primary" href="{{ path('dechet_nouveau') }}">+ Nouvelle dÃ©claration</a>
        <a class="ww-top-btn" href="#" onclick="alert('Profil bientÃ´t'); return false;">Mon profil</a>
      </div>
    </div>

    {# ===== STATS (âœ… DB) ===== #}
    <div class="ww-grid-3">
      <div class="ww-stat">
        <div class="ww-stat-label">EcoPoints</div>
        <div class="ww-stat-value">{{ ecoPoints|default(0)|number_format(0, '.', ',') }}</div>
        <div class="ww-stat-hint">Solde actuel</div>
      </div>

      <div class="ww-stat">
        <div class="ww-stat-label">DÃ©clarations</div>
        <div class="ww-stat-value">{{ stats.total|default(0) }}</div>
        <div class="ww-stat-hint">
          {{ stats.enAttente|default(0) }} en attente â€¢ {{ stats.valides|default(0) }} validÃ©es
        </div>
      </div>

      <div class="ww-stat">
        <div class="ww-stat-label">Badge</div>
        <div class="ww-stat-value">{{ badge|default('DÃ©butant') }}</div>
        <div class="ww-stat-hint">
          {% if ecoPoints|default(0) >= 2000 %}
            Niveau trÃ¨s avancÃ©
          {% elseif ecoPoints|default(0) >= 1000 %}
            Excellent progrÃ¨s
          {% elseif ecoPoints|default(0) >= 500 %}
            Bon rythme
          {% else %}
            Continue comme Ã§a
          {% endif %}
        </div>
      </div>
    </div>

    {# ===== 2 COLS ===== #}
    <div class="ww-grid-2">
      <section class="ww-card2">
        <div class="ww-card2-title">Actions rapides</div>

        <div class="ww-list">
          <a class="ww-action" href="{{ path('dechet_nouveau') }}">
            <div class="ww-action-ic">ğŸ—‘ï¸</div>
            <div>
              <div class="ww-action-title">DÃ©clarer un dÃ©chet</div>
              <div class="ww-action-sub">Type, quantitÃ©, localisation + photo</div>
            </div>
          </a>

          <a class="ww-action" href="#" onclick="alert('BientÃ´t disponible'); return false;">
            <div class="ww-action-ic">ğŸ“„</div>
            <div>
              <div class="ww-action-title">Mes dÃ©clarations</div>
              <div class="ww-action-sub">
                En attente : {{ stats.enAttente|default(0) }}
                â€¢ ValidÃ©es : {{ stats.valides|default(0) }}
                â€¢ RefusÃ©es : {{ stats.refuses|default(0) }}
              </div>
            </div>
          </a>

          <a class="ww-action" href="#" onclick="alert('BientÃ´t disponible'); return false;">
            <div class="ww-action-ic">ğŸ</div>
            <div>
              <div class="ww-action-title">RÃ©compenses</div>
              <div class="ww-action-sub">Ã‰changer tes EcoPoints</div>
            </div>
          </a>
        </div>
      </section>

      <section class="ww-card2">
        <div class="ww-card2-title">ActivitÃ© rÃ©cente</div>

        <div class="ww-activity">
          {% if recent|default([]) is empty %}
            <div class="ww-note">Aucune dÃ©claration pour le moment.</div>
          {% else %}
            {% for d in recent %}
              {% set tagClass =
                d.statut == 'VALIDE' ? 'ww-tag-ok' :
                (d.statut == 'REFUSE' ? 'ww-tag-bad' : 'ww-tag-warn')
              %}
              <div class="ww-activity-item">
                <span class="ww-tag {{ tagClass }}">{{ d.statut|replace({'_':' '}) }}</span>
                <div>
                  <div class="ww-activity-title">DÃ©claration {{ d.type }}</div>
                  <div class="ww-activity-sub">
                    {{ d.quantiteKg }} kg â€¢
                    {% if d.adresse %}
                      {{ d.adresse }}
                    {% elseif d.latitude and d.longitude %}
                      {{ d.latitude }}, {{ d.longitude }}
                    {% else %}
                      â€”
                    {% endif %}

                    {% if attribute(d, 'createdAt') is defined and d.createdAt %}
                      â€¢ {{ d.createdAt|date('d/m/Y H:i') }}
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          {% endif %}
        </div>
      </section>
    </div>

  </main>
</div>
{% endblock %}
