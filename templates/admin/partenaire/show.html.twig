{% extends 'admin/base_admin.html.twig' %}

{% block title %}Partenaire | {{ p.nomEntreprise }}{% endblock %}
{% block page_title %}Partenaires{% endblock %}

{% block sidebar %}
  {% include 'admin/_sidebar.html.twig' %}
{% endblock %}

{% block body %}

<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-4">
  <div>
    <h2 class="mb-0">üè¢ {{ p.nomEntreprise }}</h2>

    <div class="text-muted small d-flex flex-wrap gap-2 align-items-center">
      {% if p.actif %}
        <span class="badge bg-success">Actif</span>
      {% else %}
        <span class="badge bg-secondary">Inactif</span>
      {% endif %}

      <span>üìå Cat√©gorie : <b>{{ p.categorie ?: '‚Äî' }}</b></span>

      {% if p.siteWeb %}
        <span>‚Ä¢ üåê Site :
          <a href="{{ p.siteWeb }}" target="_blank" rel="noopener">{{ p.siteWeb }}</a>
        </span>
      {% endif %}
    </div>
  </div>

  <div class="d-flex gap-2 flex-wrap">
    <a class="btn btn-outline-secondary" href="{{ path('partenaire_index') }}">
      <i class="bi bi-arrow-left"></i> Liste
    </a>

    <a class="btn btn-primary" href="{{ path('recompense_new', { partenaire: p.id }) }}">
      <i class="bi bi-plus-lg"></i> Ajouter r√©compense
    </a>

    <a class="btn btn-outline-primary" href="{{ path('partenaire_edit', { id: p.id }) }}">
      <i class="bi bi-pencil"></i> Modifier
    </a>
  </div>
</div>

{# ===== FLASH ===== #}
{% for label, messages in app.flashes %}
  {% for m in messages %}
    <div class="alert alert-{{ label == 'error' ? 'danger' : label }} shadow-sm">
      {{ m }}
    </div>
  {% endfor %}
{% endfor %}

<div class="row g-4">

  {# ================= INFOS ================= #}
  <div class="col-lg-8">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-white fw-bold">Informations</div>

      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <tbody>
              <tr>
                <th style="width:180px;" class="text-muted">Nom</th>
                <td class="fw-semibold">{{ p.nomEntreprise }}</td>
              </tr>
              <tr>
                <th class="text-muted">Cat√©gorie</th>
                <td>{{ p.categorie ?: '‚Äî' }}</td>
              </tr>
              <tr>
                <th class="text-muted">Site web</th>
                <td>
                  {% if p.siteWeb %}
                    <a href="{{ p.siteWeb }}" target="_blank" rel="noopener">
                      <i class="bi bi-link-45deg"></i> {{ p.siteWeb }}
                    </a>
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>
              </tr>
              <tr>
                <th class="text-muted">Statut</th>
                <td>
                  {% if p.actif %}
                    <span class="badge bg-success">Actif</span>
                  {% else %}
                    <span class="badge bg-secondary">Inactif</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <th class="text-muted">R√©compenses</th>
                <td>
                  <span class="badge bg-light text-dark border">
                    {{ recompenses|length }} √©l√©ment(s)
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="form-text mt-3">
          Ce partenaire n‚Äôa pas de compte utilisateur. Il sert √† associer des r√©compenses.
        </div>
      </div>
    </div>
  </div>

  {# ================= ACTIONS RAPIDES ================= #}
  <div class="col-lg-4">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-white fw-bold">Actions rapides</div>

      <div class="card-body d-grid gap-2">
        <a class="btn btn-primary" href="{{ path('recompense_new', { partenaire: p.id }) }}">
          <i class="bi bi-plus-lg"></i> Nouvelle r√©compense
        </a>

        <a class="btn btn-outline-primary" href="{{ path('partenaire_edit', { id: p.id }) }}">
          <i class="bi bi-pencil"></i> Modifier partenaire
        </a>

        <a class="btn btn-outline-secondary" href="{{ path('partenaire_index') }}">
          <i class="bi bi-list-ul"></i> Liste des partenaires
        </a>

        <div class="border-top pt-3">
          <div class="text-muted small mb-2">Suppression</div>

          <form method="post"
                action="{{ path('partenaire_delete', { id: p.id }) }}"
                onsubmit="return confirm('Supprimer ce partenaire ?');">
            <input type="hidden" name="_token" value="{{ csrf_token('delete_partenaire_' ~ p.id) }}">
            <button class="btn btn-outline-danger w-100" type="submit">
              <i class="bi bi-trash"></i> Supprimer
            </button>
          </form>

          <div class="form-text mt-2">
            Attention : la suppression impacte les r√©compenses li√©es.
          </div>
        </div>

      </div>
    </div>
  </div>

</div>

{# ================= RECOMPENSES ================= #}
<div class="card shadow-sm border-0 mt-4">
  <div class="card-header bg-white d-flex align-items-center justify-content-between">
    <div class="fw-bold">üéÅ R√©compenses</div>
    <span class="badge bg-light text-dark border">{{ recompenses|length }} √©l√©ment(s)</span>
  </div>

  {% if recompenses is empty %}
    <div class="card-body">
      <div class="text-muted">
        Aucune r√©compense. Clique sur <b>‚ÄúAjouter r√©compense‚Äù</b> pour cr√©er la premi√®re.
      </div>
    </div>
  {% else %}
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Titre</th>
              <th style="width:140px;">Points</th>
              <th style="width:140px;">Stock</th>
              <th class="text-end" style="width:230px;">Actions</th>
            </tr>
          </thead>

          <tbody>
          {% for r in recompenses %}
            <tr>
              <td>
                <div class="fw-semibold">{{ r.titre }}</div>
                {% if r.description %}
                  <div class="small text-muted">
                    {{ r.description|slice(0, 70) }}{% if r.description|length > 70 %}‚Ä¶{% endif %}
                  </div>
                {% endif %}
              </td>

              <td>
                <span class="badge bg-success-subtle text-success border">
                  {{ r.pointsNecessaires ?? 0 }} pts
                </span>
              </td>

              <td>
                {% if r.stock is null %}
                  <span class="badge bg-secondary">‚Äî</span>
                {% elseif r.stock <= 0 %}
                  <span class="badge bg-danger">Rupture</span>
                {% elseif r.stock < 5 %}
                  <span class="badge bg-warning text-dark">Faible ({{ r.stock }})</span>
                {% else %}
                  <span class="badge bg-success">{{ r.stock }}</span>
                {% endif %}
              </td>

              <td class="text-end" style="white-space:nowrap;">
                <div class="btn-group" role="group">
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{{ path('recompense_show', { id: r.id }) }}"
                     title="Voir">
                    <i class="bi bi-eye"></i>
                  </a>

                  <a class="btn btn-sm btn-outline-primary"
                     href="{{ path('recompense_edit', { id: r.id }) }}"
                     title="Modifier">
                    <i class="bi bi-pencil"></i>
                  </a>
                </div>

                <span class="ms-2">
                  <form method="post"
                        action="{{ path('recompense_delete', { id: r.id }) }}"
                        onsubmit="return confirm('Supprimer cette r√©compense ?');"
                        class="d-inline">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete_recompense_' ~ r.id) }}">
                    <button class="btn btn-sm btn-outline-danger" type="submit" title="Supprimer">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </span>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}
</div>

{% endblock %}
