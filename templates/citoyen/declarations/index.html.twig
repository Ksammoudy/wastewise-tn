{# templates/citoyen/declarations.html.twig #}
{% extends 'citoyen/base.html.twig' %}

{% block title %}Mes d√©clarations | WasteWise TN{% endblock %}

{% block body %}

{# ===== HEADER ===== #}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-4">
  <div>
    <h2 class="mb-0 ww-title">üìÑ Mes d√©clarations</h2>
    <div class="ww-subtitle">Consultez et filtrez toutes vos d√©clarations.</div>
  </div>

  <div class="d-flex gap-2 flex-wrap">
    <a class="btn btn-success" href="{{ path('dechet_nouveau') }}">
      <i class="bi bi-plus-circle"></i> Nouvelle d√©claration
    </a>
    <a class="btn btn-outline-secondary" href="{{ path('app_dashboard_citoyen') }}">
      <i class="bi bi-arrow-left"></i> Dashboard
    </a>
  </div>
</div>

{# ===== FILTRES ===== #}
<div class="ww-card mb-3">
  <div class="ww-card-h">Filtres</div>
  <div class="ww-card-b">

    <form method="get">
      <div class="row g-3">

        <div class="col-12 col-md-4">
          <label class="form-label">Type</label>
          <select class="form-select" name="type">
            <option value="">-- Tous --</option>
            {% set types = ['Plastique', 'Papier', 'M√©tal', 'Verre', 'Organique', 'Autre'] %}
            {% for t in types %}
              <option value="{{ t }}" {{ (filters.type|default('') == t) ? 'selected' : '' }}>
                {{ t }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Statut</label>
          <select class="form-select" name="statut">
            <option value="">Tous</option>
            {% for s in statuts %}
              <option value="{{ s }}" {{ (filters.statut|default('') == s) ? 'selected' : '' }}>
                {{ s|replace({'_':' '}) }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">P√©riode</label>
          <div class="d-flex gap-2">
            <input class="form-control" type="date" name="dateFrom" value="{{ filters.dateFrom|default('') }}">
            <input class="form-control" type="date" name="dateTo" value="{{ filters.dateTo|default('') }}">
          </div>

          <div class="mt-2 d-flex gap-2 flex-wrap">
            <button class="btn btn-success btn-sm" type="submit">
              <i class="bi bi-funnel"></i> Filtrer
            </button>
            <a class="btn btn-outline-secondary btn-sm" href="{{ path('citoyen_declarations') }}">
              <i class="bi bi-x-circle"></i> R√©initialiser
            </a>
          </div>
        </div>

      </div>
    </form>

  </div>
</div>

{# ===== LISTE ===== #}
<div class="ww-card">
  <div class="ww-card-h d-flex align-items-center justify-content-between">
    <span>Liste des d√©clarations</span>
    <span class="text-muted small">
      {{ pagination.items|length }} r√©sultat(s)
    </span>
  </div>

  {% if pagination.items is empty %}
    <div class="ww-card-b text-muted">
      <i class="bi bi-info-circle"></i> Aucune d√©claration trouv√©e.
    </div>
  {% else %}
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Statut</th>
            <th>Type</th>
            <th>Quantit√©</th>
            <th>Date</th>
            <th>EcoPoints</th>
          </tr>
        </thead>
        <tbody>
          {% for d in pagination.items %}

            <tr>
              <td>
                {% if d.statut == 'VALIDE' %}
                  <span class="ww-badge"><i class="bi bi-check-circle"></i> VALIDE</span>
                {% elseif d.statut == 'REFUSE' %}
                  <span class="ww-badge"><i class="bi bi-x-circle"></i> REFUSE</span>
                {% else %}
                  <span class="ww-badge"><i class="bi bi-hourglass-split"></i> EN ATTENTE</span>
                {% endif %}
              </td>

              <td class="fw-semibold">{{ d.type }}</td>

              <td>{{ d.quantiteKg }} kg</td>

              <td class="text-muted">
                {{ d.createdAt ? d.createdAt|date('d/m/Y H:i') : '‚Äî' }}
              </td>

              <td>
                <div class="small text-muted">
                  {% if d.estimationEcoPoints is not null %}
                    Estimation : <b class="text-dark">{{ d.estimationEcoPoints }} pts</b>
                  {% else %}
                    Estimation : ‚Äî
                  {% endif %}
                </div>

                {% if d.statut == 'VALIDE' %}
                  <div class="small">
                    Attribu√©s :
                    {% if d.ecoPointsAttribues is not null and d.ecoPointsAttribues > 0 %}
                      <b class="text-success">{{ d.ecoPointsAttribues }} pts</b>
                    {% else %}
                      <span class="text-muted">‚Äî</span>
                    {% endif %}
                  </div>
                {% endif %}
              </td>
            </tr>

          {% endfor %}
        </tbody>
      </table>
    </div>

    {# ===== PAGINATION ===== #}
    {% if pagination.pages > 1 %}
      {% set q = app.request.query.all %}
      <div class="ww-card-b border-top">
        <nav aria-label="Pagination">
          <ul class="pagination mb-0 flex-wrap">

            {# pr√©c√©dent #}
            {% set prev = pagination.page - 1 %}
            <li class="page-item {{ pagination.page <= 1 ? 'disabled' : '' }}">
              <a class="page-link"
                 href="{{ path('citoyen_declarations', q|merge({'page': prev})) }}"
                 tabindex="-1">
                <i class="bi bi-chevron-left"></i>
              </a>
            </li>

            {# pages #}
            {% for p in 1..pagination.pages %}
              <li class="page-item {{ p == pagination.page ? 'active' : '' }}">
                <a class="page-link" href="{{ path('citoyen_declarations', q|merge({'page': p})) }}">
                  {{ p }}
                </a>
              </li>
            {% endfor %}

            {# suivant #}
            {% set next = pagination.page + 1 %}
            <li class="page-item {{ pagination.page >= pagination.pages ? 'disabled' : '' }}">
              <a class="page-link" href="{{ path('citoyen_declarations', q|merge({'page': next})) }}">
                <i class="bi bi-chevron-right"></i>
              </a>
            </li>

          </ul>
        </nav>
      </div>
    {% endif %}

  {% endif %}
</div>

{% endblock %}
