{% extends 'base.html.twig' %}

{% block title %}Déclarer tes déchets | WasteWise TN{% endblock %}

{% block stylesheets %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    .ww-form-wrap{ width:min(980px, 92vw); margin: 26px auto; }
    .ww-card2{ padding:20px; }
    #map{ height: 260px; border-radius:16px; border:1px solid rgba(0,0,0,.08); }
    .ww-grid-form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:start;
    }
    @media(max-width:900px){ .ww-grid-form{ grid-template-columns:1fr; } }
    .ww-error{ color:#b91c1c; font-size:12px; margin-top:6px; }
  </style>
{% endblock %}

{% block body %}
<div class="ww-form-wrap">
  <div class="ww-card2">
    <h2 style="margin:0 0 10px; font-weight:900;">Déclare tes déchets</h2>

    {% for msg in app.flashes('success') %}
      <div class="ww-alert" style="border-color:#bbf7d0;background:#ecfdf3;color:#166534;">{{ msg }}</div>
    {% endfor %}

    {# ✅ message général si erreurs #}
    {% if form.vars.submitted and not form.vars.valid %}
      <div class="ww-alert" style="border-color:#fecaca;background:#fff1f2;color:#991b1b;">
        Merci de corriger les erreurs du formulaire.
      </div>
    {% endif %}

    {{ form_start(form, { attr: { novalidate: 'novalidate' } }) }}

    <div class="ww-grid-form">
      <div>
        <div class="ww-field">
          {{ form_label(form.type) }}
          {{ form_widget(form.type) }}
          <div class="ww-error">{{ form_errors(form.type) }}</div>
        </div>

        <div class="ww-field">
          {{ form_label(form.quantiteKg) }}
          {{ form_widget(form.quantiteKg) }}
          <div class="ww-error">{{ form_errors(form.quantiteKg) }}</div>
        </div>

        <div class="ww-field">
          {{ form_label(form.adresse, 'Localisation') }}
          {{ form_widget(form.adresse) }}
          <div class="ww-error">{{ form_errors(form.adresse) }}</div>
          <div style="color:var(--ww-muted); font-size:12px; margin-top:6px;">
            Clique sur la carte pour choisir l’emplacement.
          </div>
        </div>

        {{ form_widget(form.latitude) }}
        {{ form_widget(form.longitude) }}

        <button class="ww-btn" style="margin-top:10px;">Valider</button>
      </div>

      <div>
        <div id="map"></div>
      </div>
    </div>

    {{ form_end(form) }}
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const latInput  = document.getElementById("dechet_latitude");
  const lngInput  = document.getElementById("dechet_longitude");
  const addrInput = document.getElementById("dechet_adresse");

  const defaultLat = 36.8065;
  const defaultLng = 10.1815;

  const map = L.map('map').setView([defaultLat, defaultLng], 12);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let marker = null;

  async function reverseGeocode(lat, lng){
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    if(!res.ok) return null;
    const data = await res.json();
    return data.display_name || null;
  }

  map.on('click', async function(e){
    const { lat, lng } = e.latlng;

    if(marker) map.removeLayer(marker);
    marker = L.marker([lat, lng]).addTo(map);

    latInput.value = lat.toFixed(6);
    lngInput.value = lng.toFixed(6);

    addrInput.value = "Chargement adresse...";
    const addr = await reverseGeocode(lat, lng);
    addrInput.value = addr ? addr : `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  });

  if(latInput.value && lngInput.value){
    const lat = parseFloat(latInput.value);
    const lng = parseFloat(lngInput.value);
    marker = L.marker([lat,lng]).addTo(map);
    map.setView([lat,lng], 14);
  }
</script>
{% endblock %}
