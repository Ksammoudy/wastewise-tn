{% extends 'valorisateur/base_valorizateur.html.twig' %}

{% block title %}Appels d‚Äôoffres | WasteWise TN{% endblock %}

{% block body %}

  {# ===== HEADER ===== #}
  <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-2 mb-3">
    <div>
      <h3 class="mb-1">üì£ Appels d‚Äôoffres</h3>
      <div class="text-muted">Liste ‚Ä¢ recherche ‚Ä¢ tri</div>
    </div>

    <a class="btn btn-success" href="{{ path('val_appel_new') }}">
      <i class="bi bi-plus-circle"></i> Cr√©er
    </a>
  </div>

  {# ===== FLASH (inutile si d√©j√† dans base_valorizateur) ===== #}
  {% for label, messages in app.flashes %}
    {% for message in messages %}
      {% set bs = label == 'error' ? 'danger' : label %}
      <div class="alert alert-{{ bs }} shadow-sm">
        {{ message }}
      </div>
    {% endfor %}
  {% endfor %}

  {# ===== FILTRES ===== #}
  <div class="card shadow-sm mb-3">
    <div class="card-header fw-bold d-flex align-items-center justify-content-between flex-wrap gap-2">
      <span>Recherche</span>
      <span class="text-muted small">
        <i class="bi bi-info-circle"></i> Utilise un mot cl√© + tri
      </span>
    </div>

    <div class="card-body">
      <form method="get" class="row g-2 align-items-end">

        <div class="col-12 col-lg-5">
          <label class="form-label fw-semibold" for="q">Mot cl√©</label>
          <input id="q" class="form-control" name="q" value="{{ q|default('') }}"
                 placeholder="Titre ou description..." />
        </div>

        <div class="col-12 col-md-4 col-lg-3">
          <label class="form-label fw-semibold" for="sort">Trier par</label>
          <select id="sort" class="form-select" name="sort">
            <option value="createdAt" {{ (sort|default('createdAt')) == 'createdAt' ? 'selected' : '' }}>Cr√©ation</option>
            <option value="titre" {{ sort == 'titre' ? 'selected' : '' }}>Titre</option>
            <option value="statut" {{ sort == 'statut' ? 'selected' : '' }}>Statut</option>
            <option value="dateDebut" {{ sort == 'dateDebut' ? 'selected' : '' }}>Date d√©but</option>
            <option value="dateFin" {{ sort == 'dateFin' ? 'selected' : '' }}>Date fin</option>
          </select>
        </div>

        <div class="col-12 col-md-3 col-lg-2">
          <label class="form-label fw-semibold" for="dir">Ordre</label>
          <select id="dir" class="form-select" name="dir">
            <option value="DESC" {{ (dir|default('DESC')) == 'DESC' ? 'selected' : '' }}>DESC</option>
            <option value="ASC" {{ dir == 'ASC' ? 'selected' : '' }}>ASC</option>
          </select>
        </div>

        <div class="col-12 col-lg-2 d-flex gap-2">
          <button class="btn btn-primary w-100" type="submit">
            <i class="bi bi-funnel"></i> Filtrer
          </button>

          {# Reset : route simple (sans query string) #}
          <a class="btn btn-outline-secondary w-100" href="{{ path('val_appel_index') }}">
            <i class="bi bi-x-circle"></i> Reset
          </a>
        </div>

      </form>
    </div>
  </div>

  {# ===== LISTE ===== #}
  <div class="card shadow-sm">
    <div class="card-header fw-bold d-flex align-items-center justify-content-between">
      <span>Liste</span>
      <span class="badge bg-light text-dark border">
        Total : {{ appels|length }}
      </span>
    </div>

    {% if appels is empty %}
      <div class="card-body text-muted">Aucun appel trouv√©.</div>
    {% else %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Titre</th>
              <th>Statut</th>
              <th>Date d√©but</th>
              <th>Date fin</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>

          <tbody>
            {% for a in appels %}
              {% set st = a.statut|default('BROUILLON') %}
              {% set badgeClass =
                st == 'PUBLIE' ? 'text-bg-success' :
                (st == 'BROUILLON' ? 'text-bg-secondary' :
                (st == 'FERME' ? 'text-bg-danger' : 'text-bg-warning'))
              %}

              <tr>
                <td>
                  <div class="fw-semibold">{{ a.titre }}</div>
                  <div class="text-muted small">#{{ a.id }}</div>
                </td>

                <td>
                  <span class="badge {{ badgeClass }}">{{ st }}</span>
                </td>

                <td>{{ a.dateDebut ? a.dateDebut|date('d/m/Y') : '‚Äî' }}</td>
                <td>{{ a.dateFin ? a.dateFin|date('d/m/Y') : '‚Äî' }}</td>

                <td class="text-end">
                  <div class="btn-group" role="group" aria-label="Actions">
                    <a class="btn btn-outline-secondary btn-sm"
                       href="{{ path('val_appel_show', {id: a.id}) }}" title="Voir">
                      <i class="bi bi-eye"></i>
                    </a>

                    <a class="btn btn-outline-primary btn-sm"
                       href="{{ path('val_appel_edit', {id: a.id}) }}" title="Modifier">
                      <i class="bi bi-pencil"></i>
                    </a>

                    <form method="post"
                          action="{{ path('val_appel_delete', {id: a.id}) }}"
                          onsubmit="return confirm('Supprimer cet appel ?');"
                          class="d-inline m-0">
                      <input type="hidden" name="_token" value="{{ csrf_token('delete_appel_' ~ a.id) }}">
                      <button class="btn btn-outline-danger btn-sm" type="submit" title="Supprimer">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    {% endif %}
  </div>

{% endblock %}
