{# templates/valorisateur/historique.html.twig #}
{% extends 'valorisateur/base_valorizateur.html.twig' %}

{% block title %}Historique | Valorisateur - WasteWise TN{% endblock %}

{% block body %}

  {% set filters = filters|default({}) %}
  {% set limit   = limit|default(10) %}
  {% set page    = page|default(1) %}
  {% set pages   = pages|default(1) %}
  {% set total   = total|default(0) %}

  {% set STATUT_VALIDE = STATUT_VALIDE|default('VALIDE') %}
  {% set STATUT_REFUSE = STATUT_REFUSE|default('REFUSE') %}

  <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-2 mb-3">
    <div>
      <h3 class="mb-1">üìÅ Historique des d√©clarations trait√©es</h3>
      <div class="text-muted">VALID√âES + REFUS√âES (filtres & pagination)</div>
    </div>

    <a class="btn btn-outline-secondary" href="{{ path('app_dashboard_valorizateur') }}">
      <i class="bi bi-arrow-left"></i> Dashboard
    </a>
  </div>

  {# ===== FILTRES ===== #}
  <div class="card shadow-sm mb-3">
    <div class="card-header fw-bold d-flex align-items-center justify-content-between flex-wrap gap-2">
      <span>Filtres</span>
      <span class="text-muted small">
        Total : <b class="text-dark">{{ total }}</b>
      </span>
    </div>

    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">

        <div class="col-12 col-md-3">
          <label class="form-label fw-semibold">Type</label>
          <input class="form-control"
                 name="type"
                 value="{{ filters.type|default('') }}"
                 placeholder="plastique, papier..." />
          <div class="form-text">Filtre texte (contient)</div>
        </div>

        <div class="col-12 col-md-2">
          <label class="form-label fw-semibold">Statut</label>
          <select class="form-select" name="statut">
            <option value="" {{ (filters.statut|default('')) == '' ? 'selected' : '' }}>Tous</option>
            <option value="{{ STATUT_VALIDE }}" {{ (filters.statut|default('')) == STATUT_VALIDE ? 'selected' : '' }}>
              VALID√â
            </option>
            <option value="{{ STATUT_REFUSE }}" {{ (filters.statut|default('')) == STATUT_REFUSE ? 'selected' : '' }}>
              REFUS√â
            </option>
          </select>
        </div>

        <div class="col-12 col-md-2">
          <label class="form-label fw-semibold">Du</label>
          <input class="form-control"
                 type="date"
                 name="dateFrom"
                 value="{{ filters.dateFrom|default('') }}" />
        </div>

        <div class="col-12 col-md-2">
          <label class="form-label fw-semibold">Au</label>
          <input class="form-control"
                 type="date"
                 name="dateTo"
                 value="{{ filters.dateTo|default('') }}" />
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label fw-semibold">Par page</label>
          <select class="form-select" name="limit">
            {% for l in [5,10,20,50] %}
              <option value="{{ l }}" {{ limit == l ? 'selected' : '' }}>{{ l }}</option>
            {% endfor %}
          </select>

          <div class="d-flex gap-2 mt-2 flex-wrap">
            <button class="btn btn-success" type="submit">
              <i class="bi bi-funnel"></i> Filtrer
            </button>
            <a class="btn btn-outline-secondary" href="{{ path('app_valorizateur_historique') }}">
              R√©initialiser
            </a>
          </div>
        </div>

      </form>
    </div>
  </div>

  {# ===== RESULTATS ===== #}
  <div class="card shadow-sm">
    <div class="card-header fw-bold d-flex align-items-center justify-content-between flex-wrap gap-2">
      <span>R√©sultats</span>
      <span class="badge bg-light text-dark border">
        {{ items|default([])|length }} affich√©(s) / {{ total }}
      </span>
    </div>

    {% set items = items|default([]) %}

    {% if items is empty %}
      <div class="card-body text-muted">
        Aucun r√©sultat.
      </div>
    {% else %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:90px;">ID</th>
              <th>Type</th>
              <th style="width:120px;">Quantit√©</th>
              <th>Adresse</th>
              <th>Citoyen</th>
              <th style="width:120px;">Statut</th>
              <th style="width:170px;">Date</th>
            </tr>
          </thead>

          <tbody>
            {% for d in items %}
              {% set st = d.statut|default('') %}
              {% set badgeClass =
                st == 'VALIDE' ? 'text-bg-success' :
                (st == 'REFUSE' ? 'text-bg-danger' : 'text-bg-secondary')
              %}

              <tr>
                <td class="fw-semibold">#{{ d.id }}</td>

                <td class="fw-semibold">{{ d.type|default('‚Äî') }}</td>

                <td>
                  <span class="badge bg-light text-dark border">
                    {{ d.quantiteKg|default(0) }} kg
                  </span>
                </td>

                <td class="text-muted">
                  {% if d.adresse %}
                    {{ d.adresse }}
                  {% elseif d.latitude is not null and d.longitude is not null %}
                    {{ d.latitude }}, {{ d.longitude }}
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>

                <td>
                  {% if d.user %}
                    <div class="fw-semibold">{{ d.user.email }}</div>
                    <div class="small text-muted">ID user: #{{ d.user.id|default('‚Äî') }}</div>
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>

                <td>
                  <span class="badge {{ badgeClass }}">
                    {{ st ? st|replace({'_':' '}) : '‚Äî' }}
                  </span>
                </td>

                <td class="text-muted small">
                  {{ d.createdAt ? d.createdAt|date('d/m/Y H:i') : '‚Äî' }}
                </td>
              </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    {% endif %}

    {# ===== PAGINATION ===== #}
    {% if items is not empty and pages > 1 %}
      {% set q = app.request.query.all %}

      <div class="card-footer bg-white d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="text-muted small">
          Page <b class="text-dark">{{ page }}</b> / {{ pages }}
        </div>

        <nav aria-label="Pagination">
          <ul class="pagination mb-0 flex-wrap">

            {# Prev #}
            <li class="page-item {{ page <= 1 ? 'disabled' : '' }}">
              {% if page > 1 %}
                {% set qPrev = q|merge({'page': page - 1}) %}
                <a class="page-link" href="{{ path('app_valorizateur_historique', qPrev) }}">‚Üê</a>
              {% else %}
                <span class="page-link">‚Üê</span>
              {% endif %}
            </li>

            {# Pages (fen√™tre autour de la page courante) #}
            {% set start = page - 2 %}
            {% set end   = page + 2 %}
            {% if start < 1 %}{% set start = 1 %}{% endif %}
            {% if end > pages %}{% set end = pages %}{% endif %}

            {% if start > 1 %}
              {% set qFirst = q|merge({'page': 1}) %}
              <li class="page-item"><a class="page-link" href="{{ path('app_valorizateur_historique', qFirst) }}">1</a></li>
              {% if start > 2 %}
                <li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>
              {% endif %}
            {% endif %}

            {% for p in start..end %}
              {% set qP = q|merge({'page': p}) %}
              <li class="page-item {{ p == page ? 'active' : '' }}">
                <a class="page-link" href="{{ path('app_valorizateur_historique', qP) }}">{{ p }}</a>
              </li>
            {% endfor %}

            {% if end < pages %}
              {% if end < pages - 1 %}
                <li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>
              {% endif %}
              {% set qLast = q|merge({'page': pages}) %}
              <li class="page-item"><a class="page-link" href="{{ path('app_valorizateur_historique', qLast) }}">{{ pages }}</a></li>
            {% endif %}

            {# Next #}
            <li class="page-item {{ page >= pages ? 'disabled' : '' }}">
              {% if page < pages %}
                {% set qNext = q|merge({'page': page + 1}) %}
                <a class="page-link" href="{{ path('app_valorizateur_historique', qNext) }}">‚Üí</a>
              {% else %}
                <span class="page-link">‚Üí</span>
              {% endif %}
            </li>

          </ul>
        </nav>
      </div>
    {% endif %}

  </div>

{% endblock %}
