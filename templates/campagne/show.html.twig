{% extends 'base.html.twig' %}
{% block title %}{{ c.titre }} | Campagne{% endblock %}

{% block body %}
<div class="ww-app">
  {% include 'campagne/_side_user.html.twig' %}

  <main class="ww-main">
    <div class="ww-topbar">
      <div>
        <div class="ww-h1">ğŸ“£ {{ c.titre }}</div>
        <div class="ww-sub">
          {{ c.dateDebut ? c.dateDebut|date('d/m/Y') : 'â€”' }}
          â†’
          {{ c.dateFin ? c.dateFin|date('d/m/Y') : 'â€”' }}
        </div>
      </div>
      <div class="ww-top-actions">
        <a class="ww-top-btn" href="{{ path('campagne_index') }}">â¬…ï¸ Retour</a>
      </div>
    </div>

    {# âœ… Flash messages #}
    {% for label, messages in app.flashes %}
      {% for msg in messages %}
        <div class="ww-card2" style="margin-bottom:10px;">
          <b>{{ label|upper }}</b> â€” {{ msg }}
        </div>
      {% endfor %}
    {% endfor %}

    <section class="ww-card2">
      <div class="ww-card2-title">DÃ©tails</div>

      <div class="ww-activity">

        <div class="ww-activity-item">
          <div style="flex:1;">
            <div class="ww-activity-title">Statut</div>
            <div class="ww-activity-sub">{{ c.statut }}</div>
          </div>

          <div>
            {% if c.statut == 'ACTIVE' %}
              <span class="ww-tag ww-tag-ok">ACTIVE</span>
            {% elseif c.statut == 'BROUILLON' %}
              <span class="ww-tag ww-tag-warn">BROUILLON</span>
            {% else %}
              <span class="ww-tag ww-tag-bad">TERMINEE</span>
            {% endif %}
          </div>
        </div>

        <div class="ww-activity-item">
          <div style="flex:1;">
            <div class="ww-activity-title">Description</div>
            <div class="ww-activity-sub">{{ c.description ?: 'â€”' }}</div>
          </div>
        </div>

      </div>
    </section>

    <section class="ww-card2">
      <div class="ww-card2-title">Participation</div>

      {% if not app.user %}
        <div class="ww-sub">Connecte-toi pour rejoindre une campagne.</div>
        <a class="ww-btn ww-btn-mini" href="{{ path('app_login') }}">ğŸ”‘ Connexion</a>

      {% else %}
        {% if joined %}
          <form method="post"
                action="{{ path('campagne_leave', { id: c.id }) }}"
                onsubmit="return confirm('Quitter cette campagne ?');">
            <input type="hidden" name="_token" value="{{ csrf_token('leave_campagne_' ~ c.id) }}">
            <button class="ww-btn ww-btn-mini ww-btn-danger" type="submit">ğŸšª Quitter</button>
          </form>

        {% else %}
          {# âœ… on bloque le join si pas ACTIVE #}
          {% if c.statut != 'ACTIVE' %}
            <div class="ww-sub">Cette campagne n'est pas joinable (statut : <b>{{ c.statut }}</b>).</div>
            <button class="ww-btn ww-btn-mini" type="button" disabled style="opacity:.6; cursor:not-allowed;">
              âœ… Rejoindre
            </button>
          {% else %}
            <form method="post" action="{{ path('campagne_join', { id: c.id }) }}">
              <input type="hidden" name="_token" value="{{ csrf_token('join_campagne_' ~ c.id) }}">
              <button class="ww-btn ww-btn-mini" type="submit">âœ… Rejoindre</button>
            </form>

            <div class="ww-stat-hint" style="margin-top:8px;">
              * Rejoindre est possible seulement si la campagne est <b>ACTIVE</b>.
            </div>
          {% endif %}
        {% endif %}
      {% endif %}
    </section>

  </main>
</div>
{% endblock %}
